#
# Copyright 2007-2016, Kaazing Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

## This test came from converting rtest project (http://svn.kaazing.wan/gateway.server.rtests/) to robot test.
## This test might represent 3.6.x.y client behavior since the origin of rtests project was 3.6.x.y code line.


connect tcp://127.0.0.1:8001
connected

# Connection request
write "GET /echoAuth?.kl=Y HTTP/1.1\r\n"
write "Upgrade: websocket\r\n"
write "Connection: Upgrade\r\n"
write "Host: localhost:8001\r\n"
write "Origin: http://localhost:8001\r\n"
write "Sec-WebSocket-Protocol: x-kaazing-handshake\r\n"
write "Sec-WebSocket-Key: nDaimG37f4nUqogPypithw==\r\n"
write "Sec-WebSocket-Version: 13\r\n"
write "\r\n"

# 101 Response
read "HTTP/1.1 101 Web Socket Protocol Handshake\r\n"
read "Connection: Upgrade\r\n"
read /Date: .*\r\n/
read /Sec-WebSocket-Accept: .*\r\n/
read "Sec-WebSocket-Protocol: x-kaazing-handshake\r\n"
read "Server: Kaazing Gateway\r\n"
read "Upgrade: websocket\r\n"
read "\r\n"
#read "Sec-WebSocket-Origin: http://localhost:8001\r\n"
#read "Sec-WebSocket-Location: ws://localhost:8001/echoAuth?.kl=Y\r\n"
#read "X-Frame-Type: binary\r\n"
# binary-encoded balancer directive - NO balance needed       
read [0x82 0x04 0xEF 0x83 0xBF 0x4E]

# Masked Request
write [0x81 0xE5 0xB1 0x34 0x9C 0x39 0xF6 0x71 0xC8 0x19 0x9E 0x51 0xFF 0x51 0xDE 0x75 0xE9 0x4D 0xD9 0x14 0xD4 0x6D 0xE5 0x64 0xB3 0x08 0x9F 0x05 0x91 0x33 0xE6 0x51 0xFE 0x6A 0xDE 0x57 0xF7 0x5C 0xC5 0x19 0xCC 0x4B 0xDE 0x40 0xF3 0x5A 0xDE 0x58 0xA6 0x19 0xBC 0x3E 0xCF 0x5C 0xD2 0x19 0xCB 0x5C 0xD3 0x67 0xF3 0x5A 0xDA 0x51 0xE8 0x14 0xF4 0x4C 0xE8 0x5C 0xDF 0x47 0xF5 0x56 0xDF 0x47 0xA6 0x19 0xC9 0x19 0xF7 0x58 0xD0 0x4E 0xF5 0x57 0xD6 0x19 0xF4 0x4D 0xC5 0x44 0xB1 0x4B 0xD4 0x42 0xFD 0x55 0xD8 0x50 0xFD 0x4D 0xD4 0x39 0x96 0x34 0xBB]

# 401 Unauthorized response
read [0x82 0x7E 0x00 0xAF ]
read "HTTP/1.1 401 Unauthorized\r\n"
read "Content-Type: text/html\r\n"
read "WWW-Authenticate: Application Token\r\n"
read "Content-Length: 64\r\n"
read "\r\n"
read "<html><head></head><body><h1>401 Unauthorized</h1></body></html>"
read [0x82 0x00]

# Masked Request
write [0x81 0xFE 0x00 0x8C 0xB1 0x34 0x9C 0x39 0xF6 0x71 0xC8 0x19 0x9E 0x51 0xFF 0x51 0xDE 0x75 0xE9 0x4D 0xD9 0x14 0xD4 0x6D 0xE5 0x64 0xB3 0x08 0x9F 0x05 0x91 0x33 0xF0 0x41 0xE8 0x51 0xDE 0x46 0xF5 0x43 0xD0 0x40 0xF5 0x56 0xDF 0x0E 0xBC 0x7B 0xD0 0x47 0xF5 0x5A 0x91 0x55 0xF1 0x00 0xDD 0x7B 0xF2 0x5D 0xDD 0x56 0xDB 0x77 0xC7 0x56 0xCB 0x6C 0x8C 0x39 0x96 0x6E 0xD4 0x56 0xCF 0x56 0xD2 0x5F 0xF9 0x4D 0x9C 0x64 0xEE 0x56 0xC5 0x5B 0xFF 0x56 0xDD 0x0E 0xBC 0x34 0xBB 0x67 0xF9 0x5A 0x9C 0x63 0xF9 0x5B 0xE2 0x5B 0xFF 0x52 0xD4 0x40 0xB1 0x7C 0xC9 0x40 0xF9 0x57 0xC2 0x5D 0xF3 0x57 0xC2 0x0E 0xBC 0x41 0x9C 0x5F 0xFD 0x58 0xCB 0x5D 0xF2 0x5E 0x9C 0x5C 0xE8 0x4D 0xC1 0x19 0xEE 0x5C 0xC7 0x55 0xF0 0x50 0xD5 0x55 0xE8 0x5C 0xBC 0x3E 0x91 0x33]

# 400 Response
read [0x82 0x7E 0x00 0xA8]
read "HTTP/1.1 400 Bad Request\r\n"
read "Content-Type: text/html\r\n"
read "Content-Length: 95\r\n"
read "\r\n"
read "<html><head></head><body><h1>400 Expected challenge scheme 'Token' not found</h1></body></html>"
read [0x82 0x00]

close
closed